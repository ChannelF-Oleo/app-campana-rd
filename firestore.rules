rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // 1. FUNCIONES DE AYUDA (REUTILIZABLES)
    // ==========================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
    }

    // Permite ver el perfil de TU LÍDER (Subordinado -> Jefe)
    function isMyAssignedLeader(leaderId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.liderAsignado == leaderId;
    }

    // ==========================================================
    // 2. COLECCIÓN: USERS (Perfiles de Equipo)
    // ==========================================================
    match /users/{userId} {
      
      // Nueva función auxiliar local:
      // ¿El documento que intentas leer dice que TÚ eres su líder?
      function isAssignedToMe() {
        return isSignedIn() && resource.data.liderAsignado == request.auth.uid;
      }

      // LEER (get): 
      // 1. Es mi perfil (isOwner)
      // 2. Soy Admin (isAdmin)
      // 3. Es el perfil de mi jefe (isMyAssignedLeader)
      // 4. NUEVO: Es el perfil de alguien de mi equipo (isAssignedToMe)
      allow get: if isOwner(userId) || isAdmin() || isMyAssignedLeader(userId) || isAssignedToMe();
      
      // LISTAR (consultas): 
      // 1. Admin
      // 2. NUEVO: Consultas donde filtro por "liderAsignado == mi ID"
      allow list: if isAdmin() || isAssignedToMe();

      // CREAR: Permitido si el UID coincide (Login Google/AuthContext)
      allow create: if isOwner(userId);
      
      // ACTUALIZAR: Admin (todo) o Dueño (campos limitados).
      allow update: if isAdmin() 
                    || (isOwner(userId) && 
                        request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['lastActivity', 'forceLogout', 'goal', 'fotoUrl', 'customPhotoUrl']));

      // BORRAR: Solo Admin.
      allow delete: if isAdmin();
    }

    // ==========================================================
    // 3. COLECCIÓN: SIMPATIZANTES (Registros)
    // ==========================================================
    match /simpatizantes/{docId} {
      // CREAR: Usuarios logueados.
      allow create: if isSignedIn();

      // LEER: Todo el equipo logueado.
      allow read: if isSignedIn();

      // EDICIÓN/BORRADO: Solo Admin.
      allow update, delete: if isAdmin();
    }

    // ==========================================================
    // 4. COLECCIÓN: VOTANTES (Padrón - Solo Lectura)
    // ==========================================================
    match /votantes/{cedula} {
      allow get: if isSignedIn();
      allow list: if false;
      allow write: if false;
    }
    
    // ==========================================================
    // 5. COLECCIÓN: ORGANIGRAMA (Gestión de Comandos)
    // ==========================================================
    match /organigrama/{docId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }
  }
}

