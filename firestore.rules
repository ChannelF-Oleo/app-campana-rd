// channelf-oleo/app-campana-rd/app-campana-rd-58cc1613209dcf6e02910bff22bbcafbb7ea6ad5/firestore.rules

rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- REGLAS PARA LA COLECCIÓN 'users' ---
    match /users/{userId} {

      // ... (Funciones Auxiliares se mantienen sin cambios) ...

      function isOwner() {
        return request.auth != null && request.auth.uid == userId;
      }

      function isAdmin() {
        return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
      }
      
      function isSignedIn() {
       return request.auth != null;
      }

      function isMyAssignedLeader() {
        return isSignedIn() && resource.data.liderAsignado == request.auth.uid;
      }
      // --- Fin Funciones Auxiliares ---


      // LEER (get): Permitir si es dueño, admin, o si es su líder asignado.
      allow get: if isOwner() || isAdmin() || isMyAssignedLeader();
      
      // LEER LISTA (list): Solo los admins pueden listar todos los usuarios.
      allow list: if isAdmin();

      // CREAR (create): Nadie puede crear usuarios desde la app.
      allow create: if false;
      
      // ACTUALIZAR (update):
      allow update: if (isOwner() && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['goal']))
                     || isAdmin();

      // BORRAR (delete): El administrador puede borrar cualquier usuario.
      // FIX I.3/B2: Se restringe el borrado solo a administradores.
      allow delete: if isAdmin(); 
    }


    // --- REGLAS PARA LA COLECCIÓN 'simpatizantes' ---
    match /simpatizantes/{simpatizanteId} {
    
       function isSignedIn() {
         return request.auth != null;
       }
       
       function isAdmin() {
         return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
       }

      // CREAR (create): Permitido a cualquiera (para formulario público y callable function).
      allow create: if true; 

      // LEER (get, list): Permitido solo a usuarios logueados (multiplicadores, líderes, admins).
      allow read: if isSignedIn();

      // ACTUALIZAR (update): No permitido desde la app.
      allow update: if false;

      // BORRAR (delete): No permitido desde la app.
      allow delete: if false;
    }
  }
}
