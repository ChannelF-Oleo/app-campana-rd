rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================
    // 1. FUNCIONES DE AYUDA (REUTILIZABLES)
    // ==========================================================
    
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isAdmin() {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.rol == 'admin';
    }

    function isMyAssignedLeader(leaderId) {
      return isSignedIn() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.liderAsignado == leaderId;
    }

    // ==========================================================
    // 2. COLECCIÓN: USERS (Perfiles de Equipo)
    // ==========================================================
    match /users/{userId} {
      // LEER: El usuario, Admin o su Líder.
      allow get: if isOwner(userId) || isAdmin() || isMyAssignedLeader(userId);
      
      // LISTAR: Solo Admins.
      allow list: if isAdmin();

      // CREAR: Bloqueado (Lo hace el Backend automáticamente).
      allow create: if false;
      
      // ACTUALIZAR: Admin (todo) o Dueño (campos limitados).
      allow update: if isAdmin() 
                    || (isOwner(userId) && 
                        request.resource.data.diff(resource.data).affectedKeys()
                        .hasOnly(['lastActivity', 'forceLogout', 'goal', 'fotoUrl', 'customPhotoUrl']));

      // BORRAR: Solo Admin.
      allow delete: if isAdmin();
    }

    // ==========================================================
    // 3. COLECCIÓN: SIMPATIZANTES (Registros)
    // ==========================================================
    match /simpatizantes/{docId} {
      // CREAR: Bloqueado (Se usa Cloud Functions para validar).
      allow create: if false;

      // LEER: Todo el equipo logueado.
      allow read: if isSignedIn();

      // EDICIÓN/BORRADO: Solo Admin.
      allow update, delete: if isAdmin();
    }

    // ==========================================================
    // 4. COLECCIÓN: VOTANTES (Padrón - Solo Lectura)
    // ==========================================================
    match /votantes/{cedula} {
      // LEER: Usuarios logueados (para búsqueda).
      allow get: if isSignedIn();
      
      // LISTAR/ESCRIBIR: Bloqueado. Nadie debe modificar el padrón directamente.
      allow list: if false;
      allow write: if false;
    }
    
    // ==========================================================
    // 5. COLECCIÓN: ORGANIGRAMA (Gestión de Comandos)
    // ==========================================================
    // CORRECCIÓN CRÍTICA: Coincide con Comandos.js
    match /organigrama/{docId} {
      // LEER: Todo el equipo puede ver la estructura.
      allow read: if isSignedIn();
      
      // ESCRIBIR: Solo el Admin puede editar la estructura.
      allow write: if isAdmin();
    }
  }
}

